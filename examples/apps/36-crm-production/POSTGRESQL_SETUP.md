# PostgreSQL Connection Guide

## ðŸŽ¯ How Jounce Connects to PostgreSQL

Jounce's built-in database module connects to PostgreSQL using the `DATABASE_URL` environment variable.

---

## **Option 1: Railway (Recommended - Easiest)**

### **Step 1: Create Railway Account & Database**

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Create new project
railway init

# Add PostgreSQL database
railway add postgresql
```

Railway automatically creates:
- PostgreSQL 15 database
- Connection URL
- Environment variables

### **Step 2: Get Connection String**

```bash
# View environment variables
railway variables
```

You'll see:
```
DATABASE_URL=postgres://postgres:PASSWORD@containers-us-west-XXX.railway.app:5432/railway
```

### **Step 3: Create Database Tables**

```bash
# Connect to Railway PostgreSQL
railway connect postgresql
```

Then run this SQL:

```sql
-- Users table
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    password_hash TEXT NOT NULL,
    role TEXT DEFAULT 'sales_rep',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);

-- Deals table
CREATE TABLE deals (
    id BIGSERIAL PRIMARY KEY,
    company TEXT NOT NULL,
    value INTEGER NOT NULL,
    status TEXT NOT NULL,
    contact TEXT NOT NULL,
    owner_id BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Deal activities (audit log)
CREATE TABLE deal_activities (
    id BIGSERIAL PRIMARY KEY,
    deal_id BIGINT REFERENCES deals(id),
    user_id BIGINT REFERENCES users(id),
    action TEXT NOT NULL,
    old_status TEXT,
    new_status TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for performance
CREATE INDEX idx_deals_owner ON deals(owner_id);
CREATE INDEX idx_deals_status ON deals(status);
CREATE INDEX idx_activities_deal ON deal_activities(deal_id);
```

### **Step 4: Add Sample Data (Optional)**

```sql
-- Create test user (password: "password123")
INSERT INTO users (email, name, password_hash, role)
VALUES (
    'alice@company.com',
    'Alice Johnson',
    '$bcrypt$hash$password123',  -- In production, use real bcrypt hash
    'sales_rep'
);

-- Get user ID
SELECT id FROM users WHERE email = 'alice@company.com';
-- Let's say it returns: 1

-- Create sample deals
INSERT INTO deals (company, value, status, contact, owner_id)
VALUES
    ('Acme Corp', 50000, 'open', 'John Smith', 1),
    ('TechStart Inc', 75000, 'won', 'Sarah Johnson', 1),
    ('Global Systems', 120000, 'open', 'Mike Chen', 1);
```

### **Step 5: Configure Jounce App**

Create `.env` file in your project:

```bash
DATABASE_URL=postgres://postgres:PASSWORD@containers-us-west-XXX.railway.app:5432/railway
JWT_SECRET=your_super_secret_key_change_this_in_production
PORT=3000
```

### **Step 6: Deploy to Railway**

```bash
# Compile Jounce app
cargo run --release -- compile examples/apps/36-crm-production/main.jnc

# Deploy
cd dist
railway up
```

**Done!** Your app is live at `https://your-app.up.railway.app`

---

## **Option 2: Supabase (Free Tier Available)**

### **Step 1: Create Supabase Project**

1. Go to https://supabase.com
2. Click "New Project"
3. Choose organization
4. Enter project name
5. Generate strong database password
6. Select region (closest to your users)
7. Wait 2 minutes for provisioning

### **Step 2: Get Connection String**

1. Go to Project Settings â†’ Database
2. Find "Connection string" section
3. Select "URI" tab
4. Copy the connection string:

```
postgres://postgres.[PROJECT-ID]:[YOUR-PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres
```

**Important**: Replace `[YOUR-PASSWORD]` with your actual password!

### **Step 3: Create Tables**

Two options:

**Option A: SQL Editor (Easy)**
1. Go to SQL Editor
2. Click "New Query"
3. Paste the SQL from Step 3 above
4. Click "Run"

**Option B: psql CLI**
```bash
psql "postgres://postgres.[PROJECT-ID]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres"
```

Then paste the CREATE TABLE statements.

### **Step 4: Configure Jounce**

Create `.env` file:

```bash
DATABASE_URL=postgres://postgres.[PROJECT-ID]:[YOUR-PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres
JWT_SECRET=your_secret_key_here
PORT=3000
```

### **Step 5: Test Connection**

```bash
# Compile app
cargo run --release -- compile examples/apps/36-crm-production/main.jnc

# Test locally
cd dist
node server.js
```

Visit http://localhost:3000 - you should see the login page!

---

## **How Jounce Uses the Database Connection**

### **Connection Pooling**

Jounce automatically creates a connection pool:

```javascript
// Auto-generated by Jounce in server.js
const { Pool } = require('pg');

const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
        rejectUnauthorized: false  // Required for Railway/Supabase
    },
    max: 20,  // Maximum connections
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});
```

### **Query Execution**

When you write:
```jounce
db.query("SELECT * FROM users WHERE email = $1", [email])
```

Jounce generates:
```javascript
async function queryDatabase(sql, params) {
    const client = await pool.connect();
    try {
        const result = await client.query(sql, params);
        return result.rows[0];  // Returns first row
    } catch (error) {
        console.error('Database error:', error);
        throw error;
    } finally {
        client.release();  // Return connection to pool
    }
}
```

### **Transaction Support**

For operations that need atomicity:

```jounce
db.transaction((tx) => {
    // Update deal
    tx.query("UPDATE deals SET status = 'won' WHERE id = $1", [dealId]);

    // Log activity
    tx.query(
        "INSERT INTO deal_activities (deal_id, user_id, action, new_status)
         VALUES ($1, $2, 'marked_won', 'won')",
        [dealId, userId]
    );

    // Both succeed or both fail
});
```

---

## **Environment Variables Reference**

### **Required Variables**

```bash
# PostgreSQL connection string
DATABASE_URL=postgres://user:password@host:5432/database

# JWT secret for token signing
JWT_SECRET=your_secret_key_minimum_32_characters

# Optional: Server port (default: 3000)
PORT=3000

# Optional: Node environment
NODE_ENV=production
```

### **Connection String Format**

```
postgres://USERNAME:PASSWORD@HOST:PORT/DATABASE?options
```

**Examples:**

**Railway:**
```
postgres://postgres:aBcDeFgH@containers-us-west-12.railway.app:5432/railway
```

**Supabase:**
```
postgres://postgres.abcdefgh:MyPassword123@aws-0-us-west-1.pooler.supabase.com:6543/postgres
```

**Local PostgreSQL:**
```
postgres://localhost:5432/crm_dev
```

---

## **Security Best Practices**

### **1. Never Commit .env File**

Add to `.gitignore`:
```
.env
.env.local
.env.production
```

### **2. Use Strong JWT Secret**

Generate a secure secret:
```bash
# Generate 64-character random string
openssl rand -hex 32
```

### **3. Use SSL Connections**

Both Railway and Supabase require SSL:
```javascript
ssl: {
    rejectUnauthorized: false
}
```

For production, use verified certificates:
```javascript
ssl: {
    rejectUnauthorized: true,
    ca: fs.readFileSync('/path/to/ca-certificate.crt').toString()
}
```

### **4. Limit Database Permissions**

Create dedicated database user:
```sql
-- Create limited user (don't use postgres superuser)
CREATE USER crm_app WITH PASSWORD 'secure_password';

-- Grant only necessary permissions
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO crm_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO crm_app;
```

Then use:
```
DATABASE_URL=postgres://crm_app:secure_password@host:5432/database
```

---

## **Troubleshooting**

### **Error: "Connection timeout"**

**Cause**: Can't reach database server

**Solutions:**
1. Check DATABASE_URL is correct
2. Verify database is running (Railway/Supabase dashboard)
3. Check firewall allows connections
4. Ensure SSL is enabled

### **Error: "password authentication failed"**

**Cause**: Wrong password or username

**Solutions:**
1. Copy password exactly from Railway/Supabase
2. Check for spaces in password
3. URL-encode special characters:
   - `@` becomes `%40`
   - `#` becomes `%23`
   - `:` becomes `%3A`

### **Error: "database does not exist"**

**Cause**: Database name wrong or not created

**Solutions:**
1. Verify database name in connection string
2. Create database if needed:
   ```sql
   CREATE DATABASE crm_production;
   ```

### **Error: "relation does not exist"**

**Cause**: Tables not created

**Solution:**
Run the CREATE TABLE statements from Step 3

---

## **Performance Optimization**

### **1. Use Indexes**

Already included in setup:
```sql
CREATE INDEX idx_deals_owner ON deals(owner_id);
CREATE INDEX idx_deals_status ON deals(status);
CREATE INDEX idx_activities_deal ON deal_activities(deal_id);
```

### **2. Connection Pooling**

Jounce uses 20 connections by default. Adjust if needed:

```javascript
// In generated server.js
max: 50,  // Increase for high traffic
```

### **3. Query Optimization**

Use EXPLAIN to check query performance:
```sql
EXPLAIN ANALYZE
SELECT * FROM deals WHERE owner_id = 1;
```

### **4. Prepared Statements**

Jounce automatically uses prepared statements:
```jounce
// This uses parameterized query (safe from SQL injection)
db.query("SELECT * FROM users WHERE email = $1", [email])
```

---

## **Monitoring**

### **Railway Monitoring**

```bash
# View logs
railway logs

# View metrics
railway up
# Then visit dashboard
```

### **Supabase Monitoring**

1. Go to project dashboard
2. Click "Database" â†’ "Reports"
3. View:
   - Active connections
   - Query performance
   - Database size
   - Slow queries

---

## **Backup & Recovery**

### **Railway Backups**

Railway Pro plan includes automated backups.

Manual backup:
```bash
railway run pg_dump $DATABASE_URL > backup.sql
```

### **Supabase Backups**

Free tier: Manual backups
Pro tier: Automated daily backups

Manual backup:
```bash
pg_dump "postgres://..." > backup_$(date +%Y%m%d).sql
```

Restore:
```bash
psql "postgres://..." < backup_20250103.sql
```

---

## **Next Steps**

1. âœ… Database created and connected
2. âœ… Tables created with indexes
3. âœ… Sample data inserted
4. âœ… Environment variables configured
5. âœ… Jounce app compiled

**Now you're ready to deploy!**

See `DEPLOYMENT.md` for deployment instructions.
